---
layout: post
title: Predicting Stock Returns with a Neural Network
date: '2019-09-30T14:40:00.000+03:00'
author: Jarkko Jokelainen
tags:
nav_order: 6
modified_time: '2019-10-02T16:15:30.688+03:00'
thumbnail: /assets/images/1.bp.blogspot.com/-ztgS2OKYEcI/XZGP3mVlidI/AAAAAAAAAFo/kcMcCZrXJqk8YqXAQkmvTZk5mGuQlmstACEwYBhgL/s72-c/rautasilta_small.jpg
blogger_id: tag:blogger.com,1999:blog-3014413452006891711.post-4660568072491807312
blogger_orig_url: https://blog.boogiesoftware.com/2019/09/predicting-stock-returns-with-neural.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="/assets/images/1.bp.blogspot.com/-ztgS2OKYEcI/XZGP3mVlidI/AAAAAAAAAFo/kcMcCZrXJqk8YqXAQkmvTZk5mGuQlmstACEwYBhgL/s1600/rautasilta_small.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="240" data-original-width="320" src="/assets/images/1.bp.blogspot.com/-ztgS2OKYEcI/XZGP3mVlidI/AAAAAAAAAFo/kcMcCZrXJqk8YqXAQkmvTZk5mGuQlmstACEwYBhgL/s1600/rautasilta_small.jpg" /></a></div>I spent the summer of 2019 as a Data Analyst trainee at <a href="https://boogiesoftware.com/">Boogie Software</a>. Part of my work was to implement a small project utilizing neural networks to solve an interesting problem of my own choosing. I have experience in portfolio performance analysis, so I immediately thought of stock market data. More precisely, predicting stock returns with neural networks.&nbsp;<a href="https://boogiesoftware.com/">Boogie Software</a> has strong expertise in financial technology, so the topic fits nicely to the company profile and the whole <a href="https://boogiesoftware.com/ai/">AI team</a> was eager to contribute to the work.<br /><br />Predicting future stock returns has always been a popular topic. Reasonable estimates of expected returns are useful in many financial asset pricing models. Most investors would like to be able to pick the future winning stocks into their portfolio. Predicting stock returns is not easy, but the development of machine learning models provides new possibilities in the field of empirical asset pricing.<br /><br />In this work, we use an artificial neural network model to predict future stock returns. We also construct investment portfolios based on the predictions. We then compare the performance of the portfolios to the overall stock market. As a difference to many academic papers exploring this topic, we use publicly available data.<br /><h3>Predictive models</h3><h4><b>Multilayer perceptron (MLP)</b></h4>We study the performance of a basic feed forward artificial neural network, the <a href="https://en.wikipedia.org/wiki/Multilayer_perceptron">multilayer perceptron</a>.  We use a simple network with one hidden layer that consists of 32  nodes. Nonlinearity of the network is achieved by using the leaky <a href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)">ReLU</a> activation function. The network is trained using the Adam optimization algorithm, which is an extension to the&nbsp;<a href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent">stochastic gradient descent</a> method. Mean squared prediction error is used as the objective  function.<br /><h4>Linear model (OLS)</h4>As a reference model, we use the <a href="https://en.wikipedia.org/wiki/Linear_regression">linear regression model</a>. The linear model is computationally efficient, because the coefficients of the model can be analytically determined by  using the ordinary least squares (OLS) method.<br /><h3>Data and methodology</h3>We use price and trading volume data for U.S. stocks traded in the NYSE and NASDAQ. The data set covers 22 years starting from April 1997 and ending on March 2019. The number of stocks starts from 1590 and increases to 4568 by the end of the period. Note that this data set suffers from survival bias as it does not contain historical data for companies that have exited the market during the period. Links to the data sources can be found from the References section below.<br /><br />We limit our analysis to the top 500 stocks based on the average dollar trading volume during the previous year. The following graph shows the cumulative total return of an equally weighted (EW) portfolio using our top 500 stock selections compared to the S&amp;P 500 index. The correlation between the EW portfolio and the S&amp;P 500 index is  0.94. While not exactly the same  thing, this method mimics investing to the S&amp;P 500 index quite  well. In the analysis below, the EW portfolio is used to represent the market portfolio.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="/assets/images/1.bp.blogspot.com/-SSfSi9SVjfE/XY2hAzr7YnI/AAAAAAAAAD8/kJ98Yyf-Y2M4dF3FiUH3MytzXimOEvgYgCLcBGAsYHQ/s1600/ew_sp500.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="543" data-original-width="955" src="/assets/images/1.bp.blogspot.com/-SSfSi9SVjfE/XY2hAzr7YnI/AAAAAAAAAD8/kJ98Yyf-Y2M4dF3FiUH3MytzXimOEvgYgCLcBGAsYHQ/s1600/ew_sp500.png" /></a></td></tr><tr><td class="tr-caption" style="font-size: smaller; text-align: center;">Cumulative total return of the EW portfolio and the S&amp;P 500 index.</td></tr></tbody></table><div class="separator" style="clear: both; text-align: center;"></div><br />The response variable that we are trying to predict is the excess return  over the risk free rate (U.S. Treasury Bill yield) for each stock. W<span class="c-message__body" data-qa="message-text" dir="auto">e use predictor variables that have historically shown good predicting power and that can be computed from the available data.</span> The predictors include e.g. beta, return volatility, illiquidity and momentum return. We also use six macroeconomic variables as predictors including several variables computed from interest rates as well as stock market wide dividend to price and earnings to price ratios. We lag the variables when needed to avoid <span class="c-message__body" data-qa="message-text" dir="auto">future information from leaking into the training data.</span><br /><br />We divide the available period of data into ten years of training data and five years of validation data. The training data is used to train the MLP model. The validation data is used for early  stopping of training to avoid overfitting the model. We also utilize dropout and L1  penalization of the weight parameters as additional  regularization methods for the MLP model. The OLS model does not require the use of validation data, so we use both training and validation data to fit the model.<br /><br />The last seven years of the data set are reserved for out-of-sample testing. In out-of sample testing the models are refit once every year using monthly data from the preceding training and validation periods. The models are then used to predict next month returns using the previous month predictor variables until the next refit. <br /><h3>Prediction results </h3>We measure the predicting power of the models by computing the out-of-sample coefficient of determination (R<sup>2</sup>) using the predicted and true excess returns from the seven year testing period. The results are presented in the table below.<br /><br /><table style="border-collapse: collapse; border: 1px solid black; text-align: left; width: 40%;">  <tbody><tr style="background-color: silver; border: 1px solid black;">      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Model</th>      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px;">R<sup>2</sup></th>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">MLP</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">3.07 %</td>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">OLS</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.05 %</td>    </tr></tbody></table><br />The R<sup>2</sup> metric can be interpreted so that 3.07% of the total variance in stock excess returns is predictable by the MLP model. The OLS model seems to lack any real predicting power. Based on these results it is not feasible to try to predict the future returns of a single company using these models.<br /><h3>Portfolio performance</h3>For portfolio performance testing, we sort the 500 stocks into ten portfolios each month based on their predicted excess returns for the next month. Portfolio HI contains the 50 stocks with the highest predicted returns. Portfolio LO contains the 50 stocks with the lowest predicted returns. The graph below shows the cumulative total returns of the HI and LO portfolios for each model compared to the EW portfolio that contains all 500 stocks.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="/assets/images/1.bp.blogspot.com/-Gyo83eBdyAg/XY2gJWF0tiI/AAAAAAAAADw/Vfg_9aOiIhssc9ZX_jHlVvCCbS5yYZAZACLcBGAsYHQ/s1600/cum_total_return.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="546" data-original-width="955" src="/assets/images/1.bp.blogspot.com/-Gyo83eBdyAg/XY2gJWF0tiI/AAAAAAAAADw/Vfg_9aOiIhssc9ZX_jHlVvCCbS5yYZAZACLcBGAsYHQ/s1600/cum_total_return.png" /></a></td></tr><tr><td class="tr-caption" style="font-size: smaller; text-align: center;">Cumulative total return of the portfolios.</td></tr></tbody></table><div class="separator" style="clear: both; text-align: center;"></div><br />There is clear separation between the highest and lowest ranked portfolios, which indicates that both models are able to separate good performers from the poor ones. Furthermore, the HI portfolios outperform the EW portfolio for both models. Annualized portfolio performance metrics are shown in the following table (alpha and beta values have been computed against the EW portfolio).<br /><br /><table style="border-collapse: collapse; border: 1px solid black; text-align: left; width: 90%;">  <tbody><tr style="background-color: silver; border: 1px solid black;">      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px; width: 25%;">Metric</th>      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px; width: 13%;">MLP (HI)</th>      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px; width: 13%;">MLP (LO)</th>      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px; width: 13%;">OLS (HI)</th>      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px; width: 13%;">OLS (LO)</th>      <th style="border: 1px solid black; font-size: smaller; padding-left: 12px; width: 13%;">EW</th>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Mean excess return</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.209</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.001</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.196</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.021</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.102</td>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Volatility</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.216</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.153</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.222</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.147</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.129</td>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Sharpe ratio</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.97</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.01</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.88</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.14</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.79</td>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Maximum drawdown</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.182</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.420</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.186</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.329</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.173</td>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Turnover (monthly)</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">121%</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">129%</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">115%</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">109%</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">7.6%</td>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Alpha</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.066</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">-0.105</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.053</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">-0.073</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">N/A</td>    </tr></tbody><tbody><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Alpha t-stat</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">1.43</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">-3.60</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">1.04</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">-2.10</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">N/A</td>    </tr><tr style="border: 1px solid black;">      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">Beta</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">1.40</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">1.04</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">1.39</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">0.92</td>      <td style="border: 1px solid black; font-size: smaller; padding-left: 12px;">1.00</td>    </tr></tbody></table><br />The HI portfolios have much higher volatility (standard deviation of returns) than the EW portfolio. However,  due to their high mean returns they have higher risk-adjusted returns (Sharpe ratios) than the EW portfolio. The lowest ranked portfolios show statistically significant negative alphas. The highest ranked portfolios have strong positive alphas, but they are not statistically significant.<br /><br />One potential problem of implementing these portfolios in practice is high turnover. Rebalancing the portfolios requires trading the whole value of the portfolio each month. The strong mean returns allow for high trading costs, however. For example, the MLP (HI) portfolio maintains the excess return advantage compared to the EW portfolio up to trading costs of 0.8%.<br /><br />The risk conscious investor is probably more interested in the risk-adjusted returns than in the absolute returns. The Sharpe ratios of the HI portfolios as a function of trading costs in basis points (one hundredth of a percent) are shown in the graph below.<br /><div class="separator" style="clear: both; text-align: center;"></div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="/assets/images/1.bp.blogspot.com/-ShYt7TaG3yM/XY2hMJDYm4I/AAAAAAAAAEA/MArYzZSjl3ApIunr5fGtgE2fBEsPRpdmACLcBGAsYHQ/s1600/cost_effect_on_sr.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="543" data-original-width="964" src="/assets/images/1.bp.blogspot.com/-ShYt7TaG3yM/XY2hMJDYm4I/AAAAAAAAAEA/MArYzZSjl3ApIunr5fGtgE2fBEsPRpdmACLcBGAsYHQ/s1600/cost_effect_on_sr.png" /></a></td></tr><tr><td class="tr-caption" style="font-size: smaller; text-align: center;">The effect of trading costs to the Sharpe ratio of the portfolios.</td></tr></tbody></table><div class="separator" style="clear: both; text-align: center;"></div><br />The MLP (HI) portfolio holds the Sharpe ratio advantage compared to the EW portfolio up to trading costs of 29 basis points (0.29%). This is a realistic cost level for the investor who is willing to actively buy and sell on average 60 stocks each month. However, it should be noted that S&amp;P 500 index ETFs performed even better during the test period. Mean excess return of a typical ETF was 0.121 with a volatility of just 0.109 yielding a Sharpe ratio of 1.11 with zero trading costs after the initial investment.<br /><h3>Concluding remarks</h3>The results presented above show that the neural network model is not able to produce very accurate predictions from the noisy stock market data for a single company. It performs better than the linear model, however. Both models have predicting power when stocks are sorted into portfolios. Investing into stocks with high predicted returns can produce higher returns than the average market if the investor is willing to tolerate risk and higher transaction costs.<br /><br />In addition to the MLP, we have also studied other machine learning models in the context of predicting stock returns. For example, the <a href="https://en.wikipedia.org/wiki/Long_short-term_memory">long short-term memory (LSTM)</a> recurrent neural network is able to process sequences of data. It shows promising results that challenge the performance of the MLP model.<br /><h3>References</h3><ul><ul></ul></ul><ul><li><a href="https://boogiesoftware.com/">Boogie Software Oy</a> is a private Finnish company headquartered in Oulu,  Finland. Our unique company profile builds upon top level software  competence, entrepreneurial spirit and humane work ethics. The key to  our success is close co-operation with the most demanding customers,  understanding their business and providing accurate software solutions  for complex problems.</li></ul><ul><ul></ul></ul><ul><li>The methodology used in this work is inspired by the paper&nbsp;<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3159577">Empirical Asset Pricing via Machine Learning</a> by Gu, Kelly and Xiu (2019).</li></ul><ul><ul></ul></ul><ul><li>For stock data, a subset of the <a href="https://www.kaggle.com/">kaggle</a> dataset <a href="https://www.kaggle.com/qks1lver/amex-nyse-nasdaq-stock-histories">AMEX, NYSE, and NASDAQ stocks histories</a> was used with some additional downloads from <a href="https://finance.yahoo.com/">Yahoo Finance</a>. Interest rate data was downloaded from <a href="https://fred.stlouisfed.org/">FRED (Federal Reserve Economic Data)</a>. Market wide D/P and E/P ratios are from <a href="http://www.econ.yale.edu/~shiller/data.htm">Online Data by Robert Shiller</a>.</li></ul><ul><ul></ul></ul><ul><li>The analysis was implemented with Python using&nbsp;<a href="https://numpy.org/">numpy</a>,&nbsp;<a href="https://pandas.pydata.org/">pandas</a>, <a href="https://keras.io/">keras</a>, <a href="https://www.tensorflow.org/">tensorflow</a> and&nbsp;<a href="https://scikit-learn.org/">scikit-learn</a> libraries. The graphs have been created with <a href="https://matplotlib.org/">matplotlib</a>.</li></ul><ul><ul></ul></ul>